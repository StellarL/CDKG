<!DOCTYPE html>
<html>
<head>
    <title>全文阅读--XML全文阅读--中国知网</title>
    <link rel="icon" href="/kxreader/favicon.ico" />
    <link rel="shortcut Icon" href="/kxreader/favicon.ico" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="文献 XML KBASE CNKI 中国知网" />
    <meta name="description" content="XML文献检索" />
    <link href="/kxreader/Content/css/detail?v=qX2z2KjRAEyQiNfAbKtl7dLnsqFoQ5Jdw3TZfDf0n1k1" rel="stylesheet"/>

    <script type="text/javascript">
        var APPPATH = '/kxreader';
    </script>
</head>

<body>
    
<script type="text/javascript" src="//login.cnki.net/TopLogin/api/loginapi/get?type=top&amp;localCSS=&amp;returnurl=%2f%2fkns.cnki.net%2f%2fKXReader%2fDetail%3fTIMESTAMP%3d637132370815342500%26DBCODE%3dCJFD%26TABLEName%3dCJFDLAST2019%26FileName%3dJSJK201907003%26RESULT%3d1%26SIGN%3dXmrkz2f8LoilY%252fiT3GbiaiL1bbY%253d"></script>

<div id="headerBox" class="header">
    <div class="topbar">
        <div class="textalign">
            <a href="/kxreader/Detail?dbcode=CJFD&amp;filename=JSJK201907003&amp;align=md">
                <i class="icon-cen active" title="居中对齐"></i>
            </a>
            <a href="/kxreader/Detail?dbcode=CJFD&amp;filename=JSJK201907003&amp;align=lt">
                <i class="icon-left " title="左对齐"></i>
            </a>
        </div>
        <h6 class="free-tip"><i class="icon"></i>HTML阅读开放试用阶段，欢迎体验！</h6>
    </div>
</div>

    



<div class="btn-link" style="display: none"><a target="_blank" href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JSJK201907003&amp;v=MTAyMjg2ajU0TzN6cXFCdEdGckNVUkxPZVplUm1GeTdtVnJySUx6N0JaYkc0SDlqTXFJOUZaNFFLREg4NHZSNFQ=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">知网节</a></div>

    <div class="main">

        

    <div class="sidebar-a">
        <!--sidebar start-->
        <div class="sidenav">
            <div class="arrow"><span></span></div>
            <!--sidebar_list start-->
            <dl class="sidenav-list">
                    <dt class="tit">目录结构</dt>
                            <dd class="guide">
                                    <p><a href="#57" data-title="&lt;b&gt;1 引言&lt;/b&gt; "><b>1 引言</b></a><i></i></p>
                                                            </dd>
                            <dd class="guide">
                                    <p><a href="#61" data-title="&lt;b&gt;2 FMM在申威众核异构平台上的实现&lt;/b&gt; "><b>2 FMM在申威众核异构平台上的实现</b></a><i></i></p>
                                                                    <ul class="contentbox">
                                                <li><a href="#62" data-title="&lt;b&gt;2.1 FMM基本原理和计算过程&lt;/b&gt;"><b>2.1 FMM基本原理和计算过程</b></a></li>
                                                <li><a href="#85" data-title="&lt;b&gt;2.2 申威众核处理器体系架构&lt;/b&gt;"><b>2.2 申威众核处理器体系架构</b></a></li>
                                                <li><a href="#88" data-title="&lt;b&gt;2.3 FMM主要函数的从核实现&lt;/b&gt;"><b>2.3 FMM主要函数的从核实现</b></a></li>
                                                <li><a href="#166" data-title="&lt;b&gt;2.4 数学函数的高效实现&lt;/b&gt;"><b>2.4 数学函数的高效实现</b></a></li>
                                    </ul>
                            </dd>
                            <dd class="guide">
                                    <p><a href="#180" data-title="&lt;b&gt;3 核心函数的优化与测试&lt;/b&gt; "><b>3 核心函数的优化与测试</b></a><i></i></p>
                                                                    <ul class="contentbox">
                                                <li><a href="#181" data-title="&lt;b&gt;3.1 性能优化方法&lt;/b&gt;"><b>3.1 性能优化方法</b></a></li>
                                                <li><a href="#213" data-title="&lt;b&gt;3.2 测试结果&lt;/b&gt;"><b>3.2 测试结果</b></a></li>
                                    </ul>
                            </dd>
                            <dd class="guide">
                                    <p><a href="#220" data-title="&lt;b&gt;4 结束语&lt;/b&gt; "><b>4 结束语</b></a><i></i></p>
                                                            </dd>
                            <dd class="guide">
                                    <p><a href="#" data-title="文内图表 ">文内图表</a><i></i></p>
                                                                    <ul class="contentbox">
                                                <li><a href="#83" data-title="图2 申威&lt;i&gt;SW&lt;/i&gt;26010处理器的体系结构">图2 申威<i>SW</i>26010处理器的体系结构</a></li>
                                                <li><a href="#84" data-title="图1 &lt;i&gt;FMM&lt;/i&gt;相互作用示意图和树结构计算过程">图1 <i>FMM</i>相互作用示意图和树结构计算过程</a></li>
                                                <li><a href="#309" data-title="图3 汇编指令重排示意图">图3 汇编指令重排示意图</a></li>
                                                <li><a href="#215" data-title="&lt;b&gt;表1 采用不同优化方法时, 单核组上P2P核函数的计算时间&lt;/b&gt;"><b>表1 采用不同优化方法时, 单核组上P2P核函数的计算时间</b></a></li>
                                                <li><a href="#219" data-title="&lt;b&gt;表2 FMM主要函数的计算时间 (粒子数:8千万&lt;/b&gt;) "><b>表2 FMM主要函数的计算时间 (粒子数:8千万</b>) </a></li>
                                    </ul>
                            </dd>
                                    <dd class="guide">
                                        <h6>
                                            <p><a href="#a_bibliography">参考文献</a> </p>
                                        </h6>
                                    </dd>

            </dl>
        </div>
        <!--sidebar end-->
        &nbsp;
        <!--此处有一空格符 勿删-->
    </div>

                <div class="sidebar-b three-collumn" style="width:0;">
            <div class="refer" style="width: 0;">
                <div class="arrow off" title="参考文献"><span></span></div>
                <div class="js-scrollbox" >
                    
                    <div class="subbox active">
                        <h4>
                            <span class="tit">参考文献</span>
                            <a class="close" href="javascript:void(0)">x</a>
                        </h4>
                        <div class="side-scroller">
                            <ul class="refer-list">
                                <li id="243">


                                    <a id="bibliography_1" title=" Barnes J, Hut P.A hierarchical O (N log N) force-calculation algorithm[J].Nature, 1986, 324 (6096) :446-449." target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=A hierarchical O(NlogN) force calculation algorithm">
                                        <b>[1]</b>
                                         Barnes J, Hut P.A hierarchical O (N log N) force-calculation algorithm[J].Nature, 1986, 324 (6096) :446-449.
                                    </a>
                                </li>
                                <li id="245">


                                    <a id="bibliography_2" title=" Greengard L, Rokhlin V.A fast algorithm for particle simulations[J].Journal of Computational Physics, 1987, 73 (2) :325-348." target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=A fast algorithm for particle simulations">
                                        <b>[2]</b>
                                         Greengard L, Rokhlin V.A fast algorithm for particle simulations[J].Journal of Computational Physics, 1987, 73 (2) :325-348.
                                    </a>
                                </li>
                                <li id="247">


                                    <a id="bibliography_3" title=" Gholami A, Malhotra D, Sundar H, et al.FFT, FMM, or Multigrid?A comparative study of state-of-the-art Poisson solvers in the unit cube[J].SIAM Journal on Scientific Computing, 2014, 38 (3) :280-306." target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=FFT FMM or Multigrid?A comparative study of state-of-the-art Poisson solvers in the unit cube">
                                        <b>[3]</b>
                                         Gholami A, Malhotra D, Sundar H, et al.FFT, FMM, or Multigrid?A comparative study of state-of-the-art Poisson solvers in the unit cube[J].SIAM Journal on Scientific Computing, 2014, 38 (3) :280-306.
                                    </a>
                                </li>
                                <li id="249">


                                    <a id="bibliography_4" title=" Yahagi H, Yoshii Y.N-body code with adaptive mesh refinement[J].Proceedings of the International Astronomical Union, 2012, 558 (1) :463-475." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=SCUD&amp;filename=SCUD2B8C73D0A251E25FA3B3D251017024CE&amp;v=MTM0ODJOdkZTaVdXcjdKSUZwbWFCdUhZZk9HUWxmQ3BiUTM1TkJod3J1NnhhZz1OaTdlYXJIS0ZxTExyUHRGRmVrS0RRazd5bUJpNlUxK1BIM25yUkkwZnJLV1FjbnFDTw==&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[4]</b>
                                         Yahagi H, Yoshii Y.N-body code with adaptive mesh refinement[J].Proceedings of the International Astronomical Union, 2012, 558 (1) :463-475.
                                    </a>
                                </li>
                                <li id="251">


                                    <a id="bibliography_5" title=" Bagla J S.TreePM:A code for cosmological N-body simulations[J].Journal of Astrophysics &amp;amp; Astronomy, 2002, 23 (3-4) :185-196." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=SSJD&amp;filename=SSJD00000079406&amp;v=MTA5MTd4b3hjTUg3UjdxZWJ1ZHRGQ0RsVmJ6TkpWND1OajdCYXJPNEh0SE1yNGhNWU9zSlkzazV6QmRoNGo5OVNYcVJy&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[5]</b>
                                         Bagla J S.TreePM:A code for cosmological N-body simulations[J].Journal of Astrophysics &amp;amp; Astronomy, 2002, 23 (3-4) :185-196.
                                    </a>
                                </li>
                                <li id="253">


                                    <a id="bibliography_6" title=" Hockney R W, Eastwood J W.Particle-particle-particle-mesh (P3M) algorithms[M]//Computer Simulation Using Particles.Boca Roton, FL, USA:CRC Press, 1988:267-304." target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=Particle-particle-particle-mesh (P3M) algorithms">
                                        <b>[6]</b>
                                         Hockney R W, Eastwood J W.Particle-particle-particle-mesh (P3M) algorithms[M]//Computer Simulation Using Particles.Boca Roton, FL, USA:CRC Press, 1988:267-304.
                                    </a>
                                </li>
                                <li id="255">


                                    <a id="bibliography_7" title=" Dongarra J, Sullivan F.Introduction to the top 10 algorithms[J].Computing in Science and Engineering, 2000, 2 (1) :22-23." target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=Guest Editors Introduction to the top 10 algorithms">
                                        <b>[7]</b>
                                         Dongarra J, Sullivan F.Introduction to the top 10 algorithms[J].Computing in Science and Engineering, 2000, 2 (1) :22-23.
                                    </a>
                                </li>
                                <li id="257">


                                    <a id="bibliography_8" title=" Ishiyama T, Nitadori K, Makino J.4.45 PFLOPS astrophysical N-body simulation on K computer-The gravitational trillion-body problem[C]//Proc of the International Conference on High Performance Computing, Networking, Storage and Analysis, 2012:1-10." target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=4.45Pflops Astrophysical NBody Simulation on K Computer-The Gravitational TrillionBody Problem">
                                        <b>[8]</b>
                                         Ishiyama T, Nitadori K, Makino J.4.45 PFLOPS astrophysical N-body simulation on K computer-The gravitational trillion-body problem[C]//Proc of the International Conference on High Performance Computing, Networking, Storage and Analysis, 2012:1-10.
                                    </a>
                                </li>
                                <li id="259">


                                    <a id="bibliography_9" title=" Potter D, Stadel J, Teyssier, R.PKDGRAV3:Beyond trillion particle cosmological simulations for the next era of galaxy surveys[J].Computational Astrophysics &amp;amp; Cosmology, 2016, 4 (1) :2-13." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=SSJD&amp;filename=SSJD345DC005251D71B795B59EE3E0198BEA&amp;v=MjUwMzg5QVp1NE9lSHM0dlJFYTcwMTRRUXFYcjJjMWVMdWNOOC91Q09OdkZTaVdXcjdKSUZwbWFCdUhZZk9HUWxmQ3BiUTM1TkJod3J1NnhhZz1OajdCYXJDOEc2Vy9yNA==&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[9]</b>
                                         Potter D, Stadel J, Teyssier, R.PKDGRAV3:Beyond trillion particle cosmological simulations for the next era of galaxy surveys[J].Computational Astrophysics &amp;amp; Cosmology, 2016, 4 (1) :2-13.
                                    </a>
                                </li>
                                <li id="261">


                                    <a id="bibliography_10" >
                                        <b>[10]</b>
                                     Wang Wu, Feng Yang-de, Chi Xue-bin.Application of tree structure in N-body problem[J].Application Research of Computers, 2008, 25 (1) :42-44. (in Chinese) </a>
                                </li>
                                <li id="263">


                                    <a id="bibliography_11" >
                                        <b>[11]</b>
                                     Li Chan-yi, Wang Wu, Feng Yang-de.High efficient parallel implementation of BH algorithm on heterogeneous platforms[J].Application Research of Computers, 2016, 33 (8) :2255-2259. (in Chinese) </a>
                                </li>
                                <li id="265">


                                    <a id="bibliography_12" >
                                        <b>[12]</b>
                                     Xu Lei, Xu Ying.Investigation of the implementation of N-body problem on GPUs[J].Computer Applications and Software, 2012, 29 (1) :92-95. (in Chinese) </a>
                                </li>
                                <li id="267">


                                    <a id="bibliography_13" >
                                        <b>[13]</b>
                                     Li Qi-gang, Chai Ya-hui, Xu Wei-min, et al.Research and realization of N-body probelm on FPGA accelorator based on FMM algorithms[J].Computer Engeneering and Design, 2011, 32 (10) :3391-3394. (in Chinese) </a>
                                </li>
                                <li id="269">


                                    <a id="bibliography_14" title=" Rokhlin V, Tygert M.Fast algorithms for spherical harmonic expansions[J].SIAM Journal on Scientific Computing, 2006, 27 (6) :1903-1928." target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=Fast algorithms for spherical harmonic expansions">
                                        <b>[14]</b>
                                         Rokhlin V, Tygert M.Fast algorithms for spherical harmonic expansions[J].SIAM Journal on Scientific Computing, 2006, 27 (6) :1903-1928.
                                    </a>
                                </li>
                                <li id="271">


                                    <a id="bibliography_15" title=" Fu Hao-huan, Liao Jun-feng, Yang Jin-zhe, et al.The Sunway TaihuLight supercomputer:System and applications[J].Science China Information Sciences, 2016, 59 (7) :1-16." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JFXG201607011&amp;v=MjY4MDZPZVplUm1GeTdtVnJySUx5dlRhYkc0SDlmTXFJOUVaWVFLREg4NHZSNFQ2ajU0TzN6cXFCdEdGckNVUkw=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[15]</b>
                                         Fu Hao-huan, Liao Jun-feng, Yang Jin-zhe, et al.The Sunway TaihuLight supercomputer:System and applications[J].Science China Information Sciences, 2016, 59 (7) :1-16.
                                    </a>
                                </li>
                                <li id="273">


                                    <a id="bibliography_16" title=" Soderquist P, Leeser M.Area and performance tradeoffs in floating-point divide and square-root implementations[J].ACM Computing Surveys, 1996, 28 (3) :518-564." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=SJCM&amp;filename=SJCM13091000017385&amp;v=MTAxODRIeWptVUxmSUpsMFJieEk9TmlmSVk3SzdIdGpOcjQ5RlpPb0lEM1E4b0JNVDZUNFBRSC9pclJkR2VycVFUTW53WmVadQ==&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[16]</b>
                                         Soderquist P, Leeser M.Area and performance tradeoffs in floating-point divide and square-root implementations[J].ACM Computing Surveys, 1996, 28 (3) :518-564.
                                    </a>
                                </li>
                                <li id="275">


                                    <a id="bibliography_17" title=" Chen De-xun, Liu Xin.Design and optimization of parallel programs on Sunway TaihuLight[Z].Wuxi:Tech Manual of The National Supercomputing Center in Wuxi, 2017. (in Chinese) " target="_blank"
                                       href="http://scholar.cnki.net/result.aspx?q=Design and optimization of parallel programs on Sunway TaihuLight">
                                        <b>[17]</b>
                                         Chen De-xun, Liu Xin.Design and optimization of parallel programs on Sunway TaihuLight[Z].Wuxi:Tech Manual of The National Supercomputing Center in Wuxi, 2017. (in Chinese) 
                                    </a>
                                </li>
                                <li id="277">


                                    <a id="bibliography_10" title=" 王武, 冯仰德, 迟学斌.树结构在N体问题中的应用[J].计算机应用研究, 2008, 25 (1) :42-44." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JSYJ200801011&amp;v=MDkzMTJybzlFWllRS0RIODR2UjRUNmo1NE8zenFxQnRHRnJDVVJMT2VaZVJtRnk3bVZycklMejdTWkxHNEh0bk0=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[10]</b>
                                         王武, 冯仰德, 迟学斌.树结构在N体问题中的应用[J].计算机应用研究, 2008, 25 (1) :42-44.
                                    </a>
                                </li>
                                <li id="279">


                                    <a id="bibliography_11" title=" 李婵怡, 王武, 冯仰德.基于异构平台的BH算法高效并行实现[J].计算机应用研究, 2016, 33 (8) :2255-2259." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JSYJ201608004&amp;v=MDg2MDlqNTRPM3pxcUJ0R0ZyQ1VSTE9lWmVSbUZ5N21WcnJJTHo3U1pMRzRIOWZNcDQ5RllJUUtESDg0dlI0VDY=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[11]</b>
                                         李婵怡, 王武, 冯仰德.基于异构平台的BH算法高效并行实现[J].计算机应用研究, 2016, 33 (8) :2255-2259.
                                    </a>
                                </li>
                                <li id="281">


                                    <a id="bibliography_12" title=" 徐磊, 徐莹.多体问题在GPU上实现的讨论[J].计算机应用与软件, 2012, 29 (1) :92-95." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JYRJ201201027&amp;v=MTIxNDg2ajU0TzN6cXFCdEdGckNVUkxPZVplUm1GeTdtVnJySUx6VFpaTEc0SDlQTXJvOUhZNFFLREg4NHZSNFQ=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[12]</b>
                                         徐磊, 徐莹.多体问题在GPU上实现的讨论[J].计算机应用与软件, 2012, 29 (1) :92-95.
                                    </a>
                                </li>
                                <li id="283">


                                    <a id="bibliography_13" title=" 李琪刚, 柴亚辉, 徐炜民, 等.多体问题FMM算法在加速部件FPGA研究与实现[J], 计算机工程与设计, 2011, 32 (10) :3391-3394." target="_blank"
                                       href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=SJSJ201110035&amp;v=MDY0MzQ5R1lZUUtESDg0dlI0VDZqNTRPM3pxcUJ0R0ZyQ1VSTE9lWmVSbUZ5N21WcnJJTmlmWVpMRzRIOUROcjQ=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                        <b>[13]</b>
                                         李琪刚, 柴亚辉, 徐炜民, 等.多体问题FMM算法在加速部件FPGA研究与实现[J], 计算机工程与设计, 2011, 32 (10) :3391-3394.
                                    </a>
                                </li>
                                <li id="285">


                                    <a id="bibliography_17" >
                                        <b>[17]</b>
                                     陈德训, 刘鑫.神威&#183;太湖之光并行程序设计与优化[Z].无锡:国家超级计算无锡中心技术手册, 2017.</a>
                                </li>
                            </ul>
                            <div style='display: none;' class="zqscroller" >
                                <h4 class="">附加材料</h4>
                                <ul></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            &nbsp;
            <!--此处有一空格符 勿删-->
        </div>

        
    <div class="content">



        <!--tips start-->
                            <div class="tips">
                    <a href="http://navi.cnki.net/KNavi/JournalDetail?pcode=CJFD&amp;pykm=JSJK" target="_blank">计算机工程与科学</a>
                2019,41(07),1161-1167 DOI:10.3969/j.issn.1007-130X.2019.07.003            </div>
        <!--tips end-->
            <div class="top-title">
                <h1 class="title">
                    <span class="vm"><b>快速多极子方法在申威众核处理器上的实现和优化</b></span>
                                    </h1>

            </div>
                        <h2>
                                <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=au&amp;skey=%E7%8E%8B%E6%AD%A6&amp;code=25931754&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">王武</a>
                                <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=au&amp;skey=%E7%8E%8B%E8%88%92%E6%89%AC&amp;code=42267100&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">王舒扬</a>
                                <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=au&amp;skey=%E5%A7%9C%E9%87%91%E8%8D%A3&amp;code=09559268&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">姜金荣</a>
                                <a href="javascript:;">孟虹松</a>
                </h2>
                    <h2>
                    <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=in&amp;skey=%E4%B8%AD%E5%9B%BD%E7%A7%91%E5%AD%A6%E9%99%A2%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF%E4%B8%AD%E5%BF%83&amp;code=0021859&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">中国科学院计算机网络信息中心</a>
                    <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=in&amp;skey=%E4%B8%AD%E5%9B%BD%E7%A7%91%E5%AD%A6%E9%99%A2%E5%A4%A7%E5%AD%A6&amp;code=1698842&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">中国科学院大学</a>
                    <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=in&amp;skey=%E5%9B%BD%E5%AE%B6%E8%B6%85%E7%BA%A7%E8%AE%A1%E7%AE%97%E6%97%A0%E9%94%A1%E4%B8%AD%E5%BF%83&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">国家超级计算无锡中心</a>
            </h2>

        
<div class="link">
    <a id="aexport" class="icon icon-output"  onclick="" href="javascript:void(0);"><i></i>导出/参考文献</a>
    
    <span class="shareBoard" onmouseover="$('#sharedet').show();$('#this').addClass('shareBoardCUR')" onmouseout="$('#sharedet').hide();$('#this').removeClass('shareBoardCUR')">
        <a class="icon icon-share" href="#"><i></i>分享<em></em></a>
        <ul class="shareHide" id="sharedet" style="display: none;">
            <li><a title="复制链接" class="copy" onclick="" href="#"><i></i>复制链接</a></li>
            <li><a title="分享到新浪微博" class="xl" onclick="" href="javascript:common.ShareAction('xl');"><i></i>新浪微博</a></li>
            <li>
                <a title="分享到微信" class="wx" onclick="" href="#"><i></i>微信扫一扫</a>
                <div class="qrcode"><img src='' alt='' /></div>
            </li>
        </ul>

    </span>
    
    <a id="RefTrack" title="创建引文跟踪" class="icon icon-track" onclick="" href="javascript:void(0);"> <i></i>创建引文跟踪 </a>
    <a id="ashoucang" title="收藏" class="icon icon-favor" onclick="" href="javascript:void(0);"><i></i>收藏</a>
    <a class="icon icon-print" onclick="window.print();" href="javascript:void(0);"><i></i>打印</a>
    
    <!--版本切换 end-->
</div>
                            <div class="data" id="a_abstract">
                <span class="keys">摘<span style="font-family: 'Times New Roman';">&nbsp;&nbsp;&nbsp;&nbsp;</span>要：</span>
                <p>快速多极子方法 (FMM) 是一种求解<i>N</i>体问题的快速高效数值算法, 在宇宙学和分子动力学等模拟中具有广泛的应用。申威SW26010是一款国产众核异构处理器, 含260核心 (4核组) 。基于申威SW26010的众核架构设计和实现了快速多极子方法, 并对核心函数 (尤其是最耗时的粒子对相互作用) 系统地进行了性能优化, 包括异步DMA、SIMD向量化、循环展开、内联汇编指令调整等。以粒子对相互作用为例, 优化后代码的计算速度约为主核上运行的原始代码的400倍, 每个核组上的浮点性能达到250 GFLOPS, 即理论峰值性能的32.5%。</p>
            </div>
                    <div class="data" id="a_keywords">
                <span class="keys">关键词：</span>
                <p>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=%E5%BF%AB%E9%80%9F%E5%A4%9A%E6%9E%81%E5%AD%90%E6%96%B9%E6%B3%95&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">快速多极子方法;</a>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=%E5%BC%82%E6%9E%84%E4%BC%97%E6%A0%B8%E5%A4%84%E7%90%86%E5%99%A8&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">异构众核处理器;</a>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=%3Ci%3EN%3C%2Fi%3E%E4%BD%93%E9%97%AE%E9%A2%98&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank"><i>N</i>体问题;</a>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">性能优化;</a>
                </p>
            </div>
        
        <!--brief start-->
        
            <div class="brief">
                    <p>
                            <b>作者简介：</b>
                                                        <span>
                                    王武 (1982-) , 男, 湖北黄梅人, 博士后, 副研究员, CCF会员 (96330M) , 研究方向为并行计算。E-mail:wangwu@sccas.cn通信地址:100190北京市海淀区中关村南四街4号中国科学院软件园区2号楼;
                                </span>
                                <span>
                                    王舒扬, 通信地址:100190北京市海淀区中关村南四街4号中国科学院软件园区2号楼;
                                </span>
                                <span>
                                    姜金荣, 通信地址:100190北京市海淀区中关村南四街4号中国科学院软件园区2号楼;
                                </span>
                    </p>
                                    <p><b>收稿日期：</b>2018-10-25</p>

                    <p>

                            <b>基金：</b>
                                                        <span>国家重点研发计划 (2017YFB0203303);</span>
                                <span>中国科学院十三五信息化应用工程项目 (XXH13506-405);</span>
                    </p>
            </div>
                    <h1><b>Implementation and optimization of fast multipole method on Sunway manycore processors</b></h1>
                    <h2>
                    <span>WANG Wu</span>
                    <span>WANG Shu-yang</span>
                    <span>JIANG Jin-rong</span>
                    <span>MENG Hong-song</span>
            </h2>
                    <h2>
                    <span>Computer Network Information Center, Chinese Academy of Sciences</span>
                    <span>University of Chinese Academy of Sciences</span>
                    <span>National Supercomputing Center in Wuxi</span>
            </h2>
                            <div class="data" id="a_abstractEN">
                <span class="keys">Abstract：</span>
                <p>The fast multipole method (FMM) is a fast and efficient numerical algorithm for solving the <i>N</i>-body problem and has various applications in cosmology and molecular dynamics. Sunway SW26010 is a heterogeneous manycore processor developed independently by China with 260 cores (4 core groups) . We design and implement an FMM on SW26010 manycore architecture. We also systematically optimize the performance of kernel functions (especially for the most time-consuming particle pair interaction) , including asynchronous direct memory access (DMA) , SIMD vectorization, loop unrolling and inline assembly tuning. Taking the particle pair interaction kernel as an example, the computational speed after optimization is about 400 times higher than the raw code running on the host core, and the floating-point performance on each core group is 250 GFLOPS, which is 32.5% of the theoretical peak performance.</p>
            </div>
                    <div class="data" id="a_keywordsEN">
                <span class="keys">Keyword：</span>
                <p>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=fast%20multipole%20method%20(FMM)%20&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">fast multipole method (FMM) ;</a>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=heterogeneous%20manycore%20processor&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">heterogeneous manycore processor;</a>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=%3Ci%3EN%3C%2Fi%3E-body%20problem&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank"><i>N</i>-body problem;</a>
                        <a href="/kcms/detail/knetsearch.aspx?dbcode=CJFD&amp;sfield=kw&amp;skey=performance%20optimization&amp;code=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" target="_blank">performance optimization;</a>
                </p>
            </div>
                    <div class="brief">
                
                    <p>
                            <b>Author：</b>
                                                        <span>
                                    WANG Wu, born in 1982, post doctor, associate research fellow, CCF member (96330M) , his re-search interest includes parallel computing.Address:Building 2, Software Park, Chinese Academy of Sciences, 4Zhongguancun South 4th Street, Haidian District, Beijing 100190, P.R.China;
                                </span>
                                <span>
                                    WANG Shu-yang, Address:Building 2, Software Park, Chinese Academy of Sciences, 4Zhongguancun South 4th Street, Haidian District, Beijing 100190, P.R.China;
                                </span>
                                <span>
                                    JIANG Jin-rong, Address:Building 2, Software Park, Chinese Academy of Sciences, 4Zhongguancun South 4th Street, Haidian District, Beijing 100190, P.R.China;
                                </span>
                    </p>
                                    <p><b>Received：</b> 2018-10-25</p>
                                    <p>
                                            </p>
            </div>


        <!--brief start-->
                        <h3 id="57" name="57" class="anchor-tag"><b>1 引言</b></h3>
                <div class="p1">
                    <p id="58"><i>N</i>体问题是高性能计算的基准问题之一, 在计算宇宙学和分子动力学模拟中有许多重要的应用。以天文为例, 宇宙的演化在假设暗物质存在的前提下通过万有引力作用下的<i>N</i>体模拟得到了很好的解释。采用直接法P2P (Particle-to-Particle) 计算<i>N</i>个粒子间相互作用, 其计算复杂度为<i>O</i> (<i>N</i><sup>2</sup>) , 这限制了模拟问题的规模。20世纪80年代以来, 计算复杂度为<i>O</i> (<i>N</i> log <i>N</i>) 和<i>O</i> (<i>N</i>) 的快速算法相继提出, 从而使超大规模<i>N</i>体问题数值模拟成为可能。这些算法包括:树方法 (Tree, 也叫Barnes-Hut Method) <citation id="287" type="reference"><link href="243" rel="bibliography" /><sup>[<a class="sup">1</a>]</sup></citation>、快速多极子方法FMM (Fast Multipole Method) <citation id="288" type="reference"><link href="245" rel="bibliography" /><sup>[<a class="sup">2</a>]</sup></citation>、基于FFT (Fast Fourier Transformation) 的粒子-网格PM (Particle-Mesh) 方法<citation id="289" type="reference"><link href="247" rel="bibliography" /><sup>[<a class="sup">3</a>]</sup></citation>、多重网格方法 (Multigrid Method) <citation id="290" type="reference"><link href="249" rel="bibliography" /><sup>[<a class="sup">4</a>]</sup></citation>以及混合算法, 如PM+X, 其中X可以是P2P、Tree、FMM等<citation id="291" type="reference"><link href="251" rel="bibliography" /><link href="253" rel="bibliography" /><sup>[<a class="sup">5</a>,<a class="sup">6</a>]</sup></citation>。</p>
                </div>
                <div class="p1">
                    <p id="59">FMM是树方法的发展和改进, 它基于多极子展开、多层空间划分和树的逐层递归遍历, 实现远场作用力的快速计算, 兼具精度和速度优势, 因而被美国计算物理学会和IEEE计算机学会列为20世纪10大算法之一<citation id="292" type="reference"><link href="255" rel="bibliography" /><sup>[<a class="sup">7</a>]</sup></citation>。本文介绍FMM在申威SW26010众核异构处理器上的实现和性能优化技术, 最终性能提升了约400倍。FMM的MPI并行算法与大规模实现参考文献<citation id="293" type="reference">[<a class="sup">8</a>,<a class="sup">9</a>,<a class="sup">10</a>,<a class="sup">10</a>]</citation>, FMM在Intel Xeon Phi、GPU、FPGA等平台上的实现方法参考文献<citation id="294" type="reference">[<a class="sup">11</a>,<a class="sup">12</a>,<a class="sup">13</a>,<a class="sup">11</a>,<a class="sup">12</a>,<a class="sup">13</a>]</citation>。</p>
                </div>
                <div class="p1">
                    <p id="60">本文第2节介绍快速多极子方法的基本原理和计算流程, 申威SW26010处理器的架构, 并给出快速多极子方法在该架构下的实现策略, 包括高效数学函数的实现。第3节给出在该架构下采用的各种优化FMM性能的方法, 以及优化后FMM的测试结果。</p>
                </div>
                <h3 id="61" name="61" class="anchor-tag"><b>2 FMM在申威众核异构平台上的实现</b></h3>
                <h4 class="anchor-tag" id="62" name="62"><b>2.1 FMM基本原理和计算过程</b></h4>
                <div class="p1">
                    <p id="63"><i>N</i>体问题计算物理场中的多个粒子 (如静电场中的分子、引力场中的星体) 之间的相互作用及其运动轨道。以引力场为例, 位势和引力满足:</p>
                </div>
                <div class="p1">
                    <p id="64" class="code-formula">
                        <mathml id="64"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtable columnalign="left"><mtr><mtd><mi>Φ</mi><mo stretchy="false"> (</mo><mi mathvariant="bold-italic">r</mi><msub><mrow></mrow><mi>i</mi></msub><mo stretchy="false">) </mo><mo>=</mo><mstyle displaystyle="true"><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>Ν</mi></munderover><mrow><mfrac><mrow><mtext>G</mtext><mi>m</mi><msub><mrow></mrow><mi>i</mi></msub><mi>m</mi><msub><mrow></mrow><mi>j</mi></msub></mrow><mrow><mo stretchy="false">|</mo><mi mathvariant="bold-italic">r</mi><msub><mrow></mrow><mi>j</mi></msub><mo>-</mo><mi mathvariant="bold-italic">r</mi><msub><mrow></mrow><mi>i</mi></msub><mo stretchy="false">|</mo></mrow></mfrac></mrow></mstyle><mo>, </mo></mtd></mtr><mtr><mtd><mi>F</mi><mo stretchy="false"> (</mo><mi mathvariant="bold-italic">r</mi><msub><mrow></mrow><mi>i</mi></msub><mo stretchy="false">) </mo><mo>=</mo><mo>-</mo><mo>∇</mo><mi>Φ</mi><mo stretchy="false"> (</mo><mi mathvariant="bold-italic">r</mi><msub><mrow></mrow><mi>i</mi></msub><mo stretchy="false">) </mo></mtd></mtr></mtable></math></mathml>
                    </p>
                </div>
                <div class="p1">
                    <p id="65">其中, <i>N</i>为粒子数量, G为引力常数, <i>m</i><sub><i>i</i></sub>、<b><i>r</i></b><sub><i>i</i></sub>、<i>Φ</i> (<b><i>r</i></b><sub><i>i</i></sub>) 、<i>F</i> (<b><i>r</i></b><sub><i>i</i></sub>) 为第<i>i</i>个粒子的质量、位置、位势和所受的力, <i>i</i>=1, …, <i>N</i>。FMM需要计算场中各点位势<citation id="295" type="reference"><link href="269" rel="bibliography" /><sup>[<a class="sup">14</a>]</sup></citation>, 并按照上面的关系将位势转化为各点所受到的作用力, 再进一步计算各粒子的运动 (加速度、速度等) 。</p>
                </div>
                <div class="p1">
                    <p id="66">FMM在数学上基于位势函数在远场的多极子展开 (Multipole Expansion) , 如球谐展开<citation id="296" type="reference"><link href="269" rel="bibliography" /><sup>[<a class="sup">14</a>]</sup></citation>如下所示:</p>
                </div>
                <div class="p1">
                    <p id="67" class="code-formula">
                        <mathml id="67"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mfrac><mn>1</mn><mrow><mo stretchy="false">|</mo><mi mathvariant="bold-italic">y</mi><mo>-</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">|</mo></mrow></mfrac><mo>=</mo><mstyle displaystyle="true"><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow><mi>p</mi></munderover><mspace width="0.25em" /></mstyle><mstyle displaystyle="true"><munderover><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mo>-</mo><mi>n</mi></mrow><mi>n</mi></munderover><mspace width="0.25em" /></mstyle><mi>Μ</mi><msubsup><mrow></mrow><mi>n</mi><mi>m</mi></msubsup><mfrac><mrow><mi>Y</mi><msubsup><mrow></mrow><mi>n</mi><mi>m</mi></msubsup><mo stretchy="false"> (</mo><mi mathvariant="bold-italic">y</mi><mo stretchy="false">) </mo></mrow><mrow><mo stretchy="false">|</mo><mi mathvariant="bold-italic">y</mi><mo stretchy="false">|</mo><msup><mrow></mrow><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msup></mrow></mfrac><mo>+</mo><mi>ε</mi><msub><mrow></mrow><mi>p</mi></msub></mrow></math></mathml>
                    </p>
                </div>
                <div class="p1">
                    <p id="68">其中, <i>p</i>为阶数 (多极子数) , <i>Y</i><mathml id="69"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mi>n</mi><mi>m</mi></msubsup></mrow></math></mathml> (<b><i>y</i></b>) 为球谐函数, <i>ε</i><sub><i>p</i></sub>为<i>p</i>阶展开后的截断误差, 展开系数<i>M</i><mathml id="70"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mi>n</mi><mi>m</mi></msubsup></mrow></math></mathml>也称为多极矩, 表达式为:</p>
                </div>
                <div class="p1">
                    <p id="71" class="code-formula">
                        <mathml id="71"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mi>Μ</mi><msubsup><mrow></mrow><mi>n</mi><mi>m</mi></msubsup><mo stretchy="false"> (</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">) </mo><mo>=</mo><mo stretchy="false">|</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">|</mo><msup><mrow></mrow><mi>n</mi></msup><mi>Y</mi><msubsup><mrow></mrow><mi>n</mi><mrow><mo>-</mo><mi>m</mi></mrow></msubsup><mo stretchy="false"> (</mo><mi mathvariant="bold-italic">x</mi><mo stretchy="false">) </mo></mrow></math></mathml>
                    </p>
                </div>
                <div class="p1">
                    <p id="72">计算多极子展开系数和球谐函数时需要将平面坐标转化为球面坐标。由于远场位势的多极子展开具有严格的截断误差估计, 因此<i>FMM</i>的计算精度和计算量可通过阶数p控制。</p>
                </div>
                <div class="p1">
                    <p id="73"><i>FMM</i>将粒子所在空间进行多层盒子划分, 该划分在空间上与八叉树结构对应。为了实现方便, 各层盒子的编号采用<i>Morton</i>编码 (或<i>Hilbert</i>编码) 。对于各粒子的近场相互作用, 为了保证精度, 仍采用直接<i>P</i>2<i>P</i>计算。对于远场相互作用, 则将粒子间的作用力转换为盒子中心之间的作用, 计算过程如下:</p>
                </div>
                <div class="p1">
                    <p id="74"> (1) 层层上聚 (<i>Upward Pass</i>) 。</p>
                </div>
                <div class="p1">
                    <p id="75">①计算叶子层各盒子中粒子的多极子展开。</p>
                </div>
                <div class="p1">
                    <p id="76">②计算各粒子到叶盒子中心的展开系数 (<i>P</i>2<i>M</i> (<i>Particle</i>-<i>to</i>-<i>Multipole</i>) 变换) ;然后从最底层向上遍历树直到第2层, 计算子盒子到父盒子中心的<i>M</i>2<i>M</i> (<i>Multipole</i>-<i>to</i>-<i>Multipole</i>) 变换。</p>
                </div>
                <div class="p1">
                    <p id="77"> (2) 层层下推 (<i>Downward Pass</i>) 。</p>
                </div>
                <div class="p1">
                    <p id="78">①从第2层开始, 通过<i>M</i>2<i>L</i> (<i>Multipole</i>-<i>to</i>-<i>Local</i>) 变换将远场盒子的多极子展开转为近场盒子的局部展开, 计算各层的次相邻盒子 (它们并不相邻, 但它们的父盒子相邻) 相互作用, 比次相邻 (更远的盒子中心最终都能逐层上聚到次相邻盒子中心) ;</p>
                </div>
                <div class="p1">
                    <p id="79">②向树的底层遍历, 并通过<i>L</i>2<i>L</i> (<i>Local</i>-<i>to</i>-<i>Local</i>) 变换计算各层子盒子中心的近场局部展开, 直到最底层;</p>
                </div>
                <div class="p1">
                    <p id="80">③通过<i>L</i>2<i>P</i> (<i>Local</i>-<i>to</i>-<i>Particle</i>) 变换将叶盒子中心的展开系数转换为叶盒子中的粒子受到的远场相互作用。</p>
                </div>
                <div class="p1">
                    <p id="81"><i>FMM</i>的盒子间相互作用示意图和树结构计算过程如图1所示, 其中次相邻盒子间的<i>M</i>2<i>L</i>转换采用虚线连接, 灰色部分为邻居盒子的近场作用 (该区域内部的所有粒子成对相互作用, 需要采用<i>P</i>2<i>P</i>直接法精确计算) 。向上箭头表示<i>M</i>2<i>M</i> (向上聚集) , 向下箭头表示<i>L</i>2<i>L</i> (向下发散) , 虚线表示<i>M</i>2<i>L</i> (次相邻转移) 。</p>
                </div>
                <div class="p1">
                    <p id="82">通过分析得出, <i>FMM</i>的复杂度为O (CN) , 即计算量和存储开销随粒子数N线性增长<citation id="297" type="reference"><link href="245" rel="bibliography" /><sup>[<a class="sup">2</a>]</sup></citation>, N的系数K与展开截断阶数p和划分层数L有关, p是一个不大的常数 (p取4即可确保相对误差小于0.1%) 。</p>
                </div>
                <div class="area_img" id="83">
                                <a class="zoom-in" href="Detail/GetImg?filename=images/JSJK201907003_083.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                    <img alt="图2 申威SW26010处理器的体系结构" src="Detail/GetImg?filename=images/JSJK201907003_083.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                                </a>
                                <p class="img_tit">图2 申威<i>SW</i>26010处理器的体系结构  <a class="btn-zoomin" href="Detail/GetImg?filename=images/JSJK201907003_083.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!"></a><a class="downimg">&nbsp;&nbsp;下载原图</a></p>
                            <p class="img_tit"><i>Figure</i> 2 <i>Architecture of the Sunway SW</i>26010 <i>processor</i></p>

                </div>
                <div class="area_img" id="84">
                                <a class="zoom-in" href="Detail/GetImg?filename=images/JSJK201907003_084.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                    <img alt="图1 FMM相互作用示意图和树结构计算过程" src="Detail/GetImg?filename=images/JSJK201907003_084.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                                </a>
                                <p class="img_tit">图1 <i>FMM</i>相互作用示意图和树结构计算过程  <a class="btn-zoomin" href="Detail/GetImg?filename=images/JSJK201907003_084.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!"></a><a class="downimg">&nbsp;&nbsp;下载原图</a></p>
                            <p class="img_tit"><i>Figure</i> 1 <i>FMM interaction and</i><i>computing process in tree structure</i></p>

                </div>
                <h4 class="anchor-tag" id="85" name="85"><b>2.2 申威众核处理器体系架构</b></h4>
                <div class="p1">
                    <p id="86">申威<i>SW</i>26010处理器是一款国产众核异构处理器<citation id="298" type="reference"><link href="271" rel="bibliography" /><sup>[<a class="sup">15</a>]</sup></citation>, 每个处理器包含4个核组, 4个核组通过片上网络互连, 每个核组包含一个管理单元<i>MPE</i> (<i>Management Processing Element</i>, 也称主核) 和一个8×8的计算单元阵列<i>CPEs</i> (<i>Computing Processing Elements</i>, 也称为从核) , 并拥有独立的内存控制器 (<i>MC</i>) 和8 <i>GB DDR</i>3内存。因此, 整个处理器有260个核心, 其体系结构如图2所示。其软件环境为定制的64位<i>Linux</i>操作系统, 并支持<i>C</i>/<i>C</i>++、<i>Fortran</i>、<i>MPI</i>、<i>Athread</i>和<i>OpenAcc</i>。本文采用直接内存读取<i>DMA</i> (<i>Direct Memory Access</i>) 方式在主从核之间传输数据, 相应的<i>DMA</i>操作可调用加速线程库<i>Athread</i>函数实现。</p>
                </div>
                <div class="p1">
                    <p id="87"><i>MPE</i>支持内核模式和用户模式, 含32 <i>KB L</i>1指令缓存、32 <i>KB L</i>1数据缓存和256 <i>KB L</i>2缓存。<i>CPE</i>只支持用户模式, 含16 <i>KB L</i>1指令缓存和64 <i>KB</i>便笺式存储器<i>SPM</i> (<i>Scratch</i>-<i>Pad Memory</i>) 。<i>SPM</i>作为一个片上<i>SRAM</i>, 不仅体积小、功耗低、访问快速, 而且具备实时性保证及片内外统一编址等优势。<i>MPE</i>和<i>CPE</i>都基于64位<i>RISC</i>架构, 支持<i>SIMD</i> (<i>Single Instruction Multiple Data</i>) 和乱序执行。<i>MPE</i>主要负责计算流程管理、<i>MPI</i>通信和少量运算, 而<i>CPE</i>基本上只负责处理计算密集型的任务。由于<i>CPE</i>局存太小, 计算密集型任务采用流水线式的传输和计算。</p>
                </div>
                <h4 class="anchor-tag" id="88" name="88"><b>2.3 FMM主要函数的从核实现</b></h4>
                <div class="p1">
                    <p id="89">在快速多极子方法中, 粒子数比叶盒子数大2个量级, 因此近场盒子中的粒子对相互作用 (即<i>P</i>2<i>P</i>操作) 计算量多于其它操作。假设每个核组需要计算N个粒子相互作用, 每次从核向主核发起<i>DMA</i>操作 (<i>DMA</i>_<i>get</i>) , 获取B个粒子的位置、质量等数组, 则每个<i>CPE</i>需要传输N/B/64 次。如果叶盒子中的粒子所需存储开销过大, 受从核局存限制, 可以将这些粒子进一步分成2或4组。从核得到所需数据后调用<i>P</i>2<i>P</i>核函数 (<i>kernel</i>_<i>p</i>2<i>p</i>) 完成近场计算, 然后将各粒子的加速度信息返回给主核 (<i>DMA</i>_<i>put</i>) 。</p>
                </div>
                <div class="p1">
                    <p id="90">下文采用<i>MEM</i>代表主存, <i>SPM</i>代表局存, P和Q记录属于相同或相邻叶盒子中的粒子组编号, <i>P</i>2<i>P</i>近场计算的从核实现伪代码如下所示:</p>
                </div>
                <div class="area_img" id="304">
                                <img alt="" src="Detail/GetImg?filename=images/JSJK201907003_30400.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                            <p class="img_tit"></p>

                </div>
                <div class="p1">
                    <p id="103"><i>P</i>2<i>M</i>算子的主要操作是对每一个叶盒子中心进行多级子展开, 计算出多级展开系数, 并保存起来供逐层聚集过程使用。一个叶盒子的多级展开系数只和该盒子中的粒子有关, 因此可针对盒子进行任务分配, 并向从核提供该盒子内的粒子列表。</p>
                </div>
                <div class="p1">
                    <p id="104">首先对所有的叶盒子进行64等分, 各从核根据自己的<i>ID</i>计算相应盒子的多极子展开。由于<i>FMM</i>采用八叉树结构进行空间划分, 对于相对均匀的粒子分布, 叶节点数量在粒子规模较大的时候很容易达到64的倍数。粒子分布极不均匀, 叶盒子数不能被64整除时, 可进行余项处理。<i>P</i>2<i>M</i>函数根据从核<i>ID</i>计算所需叶盒子列表和盒子内的粒子列表, 计算多极子展开系数, 伪代码如下所示:</p>
                </div>
                <div class="area_img" id="305">
                                <img alt="" src="Detail/GetImg?filename=images/JSJK201907003_30500.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                            <p class="img_tit"></p>

                </div>
                <div class="p1">
                    <p id="118"><i>M</i>2<i>L</i>算子的作用是在八叉树的每一层将远场盒子的多级展开系数M<mathml id="119"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml>, 通过次相邻盒子间相互作用转化为近场盒子的局部展开系数<i>L</i><mathml id="120"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml>。在盒子较少的层, M2L的计算量难以隐藏从核通信的时间开销, 故我们只对盒子数较多的层使用从核进行加速。因为M2L操作是以盒子为基本单位的, 在任务分配方面, 可为每个从核安排盒子列表 (<i>boxList</i>) 。</p>
                </div>
                <div class="p1">
                    <p id="121">在计算M2L前各从核需要从主核读入<i>M</i><mathml id="122"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml>, 完成计算后再将<i>L</i><mathml id="123"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml>传给主核。对于大规模问题 (盒子数在数万量级以上) , 次相邻相互作用的盒子太多, 以至从核局存难以存放。为了减少从主核读入数据量, 每个从核对应部分次相邻盒子的M2L计算。只有极少比例的盒子处在边角处, 因此各从核可基本保证负载均衡。</p>
                </div>
                <div class="p1">
                    <p id="124">在M2L的计算过程中, 需要分段传输每个盒子的次相邻作用列表 (Interaction List) , 其伪代码如下所示:</p>
                </div>
                <div class="area_img" id="306">
                                <img alt="" src="Detail/GetImg?filename=images/JSJK201907003_30600.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                            <p class="img_tit"></p>

                </div>
                <div class="area_img" id="306">
                                <img alt="" src="Detail/GetImg?filename=images/JSJK201907003_30601.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                            <p class="img_tit"></p>

                </div>
                <div class="p1">
                    <p id="148">其中, <i>M</i><mathml id="149"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml> () 和<i>L</i><mathml id="150"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml> () 代表计算展开系数<i>M</i><mathml id="151"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml>和<i>L</i><mathml id="152"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><msubsup><mrow></mrow><mtext>n</mtext><mtext>m</mtext></msubsup></mrow></math></mathml>的函数, 二者返回相应的系数数组。</p>
                </div>
                <div class="p1">
                    <p id="153">L2P是P2M的逆向操作, 即完成逐层下推后, 将局部展开的结果作用于叶盒子中的每一个粒子, 其伪代码如下所示:</p>
                </div>
                <div class="area_img" id="307">
                                <img alt="" src="Detail/GetImg?filename=images/JSJK201907003_30700.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                            <p class="img_tit"></p>

                </div>
                <h4 class="anchor-tag" id="166" name="166"><b>2.4 数学函数的高效实现</b></h4>
                <div class="p1">
                    <p id="167">由于申威<i>SW</i>26010处理器的从核目前还不支持高效的快速数学库 (比如开方、除法、正余弦以及其它特殊函数) , 而<i>NVIDIA GPU</i>和 <i>Intel Xeon Phi</i>上都有相应函数的高效实现, 因此快速高效的数学函数的实现是能否有效利用申威理论浮点性能的瓶颈。</p>
                </div>
                <div class="p1">
                    <p id="168">对于多极子展开和局部展开, 由于球谐展开相较于泰勒展开有更好的收敛性, 因此需要将坐标转化为球坐标, 计算展开系数。为了在从核上进行快速的数学函数计算, 我们利用正余弦函数转换、周期性、奇偶性、三倍角公式和小宗量<i>Taylor</i>展开自行实现三角函数的快速近似数值计算, 而且仅需使用较少的展开阶数就可以达到需要的计算精度。</p>
                </div>
                <div class="p1">
                    <p id="169">对于<i>P</i>2<i>P</i>核心函数 (<i>kernel</i>_<i>p</i>2<i>p</i>) , 每次最内层循环都要计算粒子距离的倒数, 即开方除法, 国际上已有行之有效的卡马克算法 (<i>Carmack Algorithm</i>) <citation id="299" type="reference"><link href="273" rel="bibliography" /><sup>[<a class="sup">16</a>]</sup></citation>, 它利用牛顿迭代和精心设计的猜测值作为迭代初值, 实现开方逆快速计算, 1/<i>sqrt</i> (<i>x</i>) 的计算过程如下所示:</p>
                </div>
                <div class="area_img" id="308">
                                <img alt="" src="Detail/GetImg?filename=images/JSJK201907003_30800.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                            <p class="img_tit"></p>

                </div>
                <div class="area_img" id="308">
                                <img alt="" src="Detail/GetImg?filename=images/JSJK201907003_30801.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                            <p class="img_tit"></p>

                </div>
                <div class="p1">
                    <p id="179">其中0<i>x</i>5<i>f</i>375<i>a</i>86称为魔幻数, 选取依据请参考文献<citation id="300" type="reference">[<a class="sup">16</a>]</citation>。根据不同应用对精度的要求, 可选取适当的魔幻数和迭代次数。本文采用两次牛顿迭代便可达到所需精度。</p>
                </div>
                <h3 id="180" name="180" class="anchor-tag"><b>3 核心函数的优化与测试</b></h3>
                <h4 class="anchor-tag" id="181" name="181"><b>3.1 性能优化方法</b></h4>
                <div class="p1">
                    <p id="182">申威<i>SW</i>26010主从核通信函数的底层是基于<i>DMA</i>实现的。由于每次循环都需要调用从核函数, 这样就有频繁且大量的数据在主从核之间传输。加速线程库<i>Athread</i>为每一次通信设置了一个<i>DMA</i>描述符。在反复通信的时候, 需要不断进行描述符的初始化, 所以我们直接使用同一个描述符来执行获取规模相同的数据的<i>DMA</i>操作, 节省了<i>DMA</i>描述符的开销。</p>
                </div>
                <div class="p1">
                    <p id="183">调整<i>DMA</i>函数与计算函数的顺序, 在从核发起<i>DMA</i>通信进行主从核之间数据交换的同时, 可进行与所传数据无关且执行时间较长的计算, 使得数据传输的时间被计算时间掩盖, 这种主从异步加速可有效提高程序的浮点性能。双缓冲策略也可以隐藏<i>DMA</i>传输时间。</p>
                </div>
                <div class="p1">
                    <p id="184">测试表明<citation id="301" type="reference"><link href="275" rel="bibliography" /><link href="285" rel="bibliography" /><sup>[<a class="sup">17</a>,<a class="sup">17</a>]</sup></citation>, 当传输的数据量在4 <i>KB</i>以上时, <i>DMA</i>带宽可稳定保持在16 <i>GB</i>/<i>ps</i>, 因此我们每次传输的数据尽量不小于4 <i>KB</i> (但不能多于56 <i>KB</i>, 因为从核的<i>SPM</i>只有64 <i>KB</i>, 需要存储数据和指令) , 从而减少<i>DMA</i>启动的次数。在优化过程中尤其要避免不必要的跨步访存数组, 提高访存效率。本文采取的方式是:拼接或合并位置比较分散的小数组, 从而减少核心数据的通信次数, 缓解频繁通信请求导致的竞争, 提高带宽利用率。</p>
                </div>
                <div class="p1">
                    <p id="185"><i>SW</i>26010支持256位的<i>SIMD</i>类型声明, 因此一次可以加载4个<i>double</i>或8个<i>float</i>类型 (<i>doublev</i>4和<i>floatv</i>8) 的数据, 然后调用<i>SIMD</i>指令集对计算过程进行向量化。比如<i>simd</i>_<i>vmad</i>指令可计算<i>doublev</i>4的乘加。由于粒子的位置、加速度和位势都是3维的, 若要使用<i>SIMD</i>进行向量化则需要补一维, 使其结构变成4维。为了提高<i>SIMD</i>的加载效率, 可通过数据结构改造 (<i>AoS</i>转为<i>SoA</i>) , 且设定每次传输到从核的粒子数为4的倍数, 剩余部分粒子进行余项处理来实现。</p>
                </div>
                <div class="p1">
                    <p id="186">本文只针对<i>FMM</i>中热点函数的代码段进行<i>SIMD</i>优化, 根据需要对循环进行向量化, 或者对4个分量 (x、y、z、phi) 进行向量化。理论上这些热点代码段计算性能可提升4倍, 但由于加载和存储需要额外开销, 因此实际上可达到3倍以上的加速。</p>
                </div>
                <div class="p1">
                    <p id="187">向量化后的循环体如果包含一个反复调用的热点函数 (比如invSqrt, 在<i>P</i>2<i>P</i>核心函数中调用非常频繁) , 为了减少调用带来的开销, 可以将其作为内联函数直接嵌入循环体 (注意<i>inline</i>关键字仅仅是建议编译器做内联展开处理, 而不是强制内联嵌入) , 并进行必要的循环展开。受寄存器大小的限制, 本文只将循环展开2次。</p>
                </div>
                <div class="p1">
                    <p id="188">申威<i>SW</i>26010的<i>CPE</i>核有2条流水线分别处理数据访存和算术运算, 为了实现访存和计算重叠, 我们可以重新调整汇编指令。如图3所示, 图3<i>a</i>是编译器生成的指令顺序, 图3<i>b</i>是人工调整的指令顺序, 调整后的指令实现了x、y、z的数据访存和dx、dy、dx<sup>2</sup>计算的重叠, 并有效消除了数据依赖, 提高了计算效率。</p>
                </div>
                <div class="area_img" id="309">
                                <a class="zoom-in" href="Detail/GetImg?filename=images/JSJK201907003_30900.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">
                                    <img alt="图3 汇编指令重排示意图" src="Detail/GetImg?filename=images/JSJK201907003_30900.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
                                </a>
                                <p class="img_tit">图3 汇编指令重排示意图  <a class="btn-zoomin" href="Detail/GetImg?filename=images/JSJK201907003_30900.jpg&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!"></a><a class="downimg">&nbsp;&nbsp;下载原图</a></p>
                            <p class="img_tit">Figure 3 Rearrangement of assembly instructions</p>

                </div>
                <h4 class="anchor-tag" id="213" name="213"><b>3.2 测试结果</b></h4>
                <div class="p1">
                    <p id="214">本文测试平台为国家超级计算无锡中心的超级计算机“神威·太湖之光”, 它基于国产申威<i>SW</i>26010众核异构处理器, 并于2016～2017连续两年位居<i>TOP</i>500世界第一。本文只测试单核组上<i>FMM</i>的计算性能。为了充分挖掘申威众核异构处理器的计算能力, 分别测试了<i>FMM</i>在不同规模、采用不同优化方法时, <i>P</i>2<i>P</i>核心函数的计算时间, 测试结果如表1所示。为了方便比较, 表1中的算例统一采用4层8叉树划分, 叶盒子个数为4 096。</p>
                </div>
                <div class="area_img" id="215">
                    <p class="img_tit"><b>表1 采用不同优化方法时, 单核组上P2P核函数的计算时间</b> <a class="downexcel" onclick="DownLoadReportExcel(this)">导出到EXCEL</a></p>
                    <p class="img_tit"><b>Table 1 Runtime of P2P kernel function in the single-core group by different optimization methods</b></p>
                    <p class="img_note"> s</p>
                    <table id="215" border="1"><tr><td rowspan="2"><br /> 采用的算法改进<br />或性能优化方法</td><td colspan="3"><br />单核组上的粒子规模</td></tr><tr><td><br />100万</td><td>200万</td><td>400万</td></tr><tr><td><br />MPE核上运行</td><td>253.42</td><td>1 012.13</td><td>4 044.41</td></tr><tr><td><br />DMA从核化</td><td>10.51</td><td>42.18</td><td>167.92</td></tr><tr><td><br />SIMD向量化</td><td>3.10</td><td>12.18</td><td>47.98</td></tr><tr><td><br />DMA跨步优化</td><td>2.71</td><td>10.46</td><td>41.07</td></tr><tr><td><br />invSqrt函数内联</td><td>1.81</td><td>6.99</td><td>27.37</td></tr><tr><td><br />减少1步牛顿迭代</td><td>1.45</td><td>5.57</td><td>21.77</td></tr><tr><td><br />内部循环展开</td><td>1.15</td><td>4.38</td><td>17.13</td></tr><tr><td><br />汇编指令重排</td><td>0.71</td><td>2.64</td><td>10.15</td></tr></table>
                    <form name="form" action="/kxreader/Detail/DownloadReportExcel" method="POST" style="display:inline">
                        <input type="hidden" name="hidTable" value="" />
                        <input type="hidden" name="hidFileName" value="" />
                    </form>
                    <p class="img_note"></p>
                    <p class="img_note"></p>
                </div>
                <div class="p1">
                    <p id="216">从表1中可以看出, 粒子数取400万时, 优化后的FMM程序与在主核上运行原始代码相比, 计算速度提高了约400倍 (从4 044.41 s缩短到10.15 s) , 此时10.15 s对应的峰值性能为250 GFLOPS。SW26010每个从核单元的峰值性能为12 GFLOPS, 因此P2P核心函数的浮点峰值效率为32.5%。相比之下, 2012年日本的TreePM算法在“京”上的峰值效率为42%<citation id="302" type="reference"><link href="257" rel="bibliography" /><sup>[<a class="sup">8</a>]</sup></citation>, 2016年美国的PKDGRAV3 (Parallel KD-tree GRAVity solver) 在Titan上的峰值效率为37%<citation id="303" type="reference"><link href="259" rel="bibliography" /><sup>[<a class="sup">9</a>]</sup></citation>, 它们都是代表当时国际上性能最高的FMM实现, 本文在神威·太湖之光上优化的FMM峰值效率已经接近该水平。</p>
                </div>
                <div class="p1">
                    <p id="217">本文还测试了单核组最大规模:粒子数为8千万, 采用5层八叉树划分, 叶盒子个数为32 768。此时采用优化后的FMM, 各主要函数运行时间如表2所示。从表2中可以看出, 尽管比其它函数用了更多的优化方法, P2P依然是最耗时的函数;其次是粒子与盒子间的P2M、M2L以及次相邻盒子间的M2L相互作用转换函数。这是因为父子盒子之间的M2M、L2L转换函数调用次数远不如前面4个函数的调用次数, 而且粒子数量远远多于盒子数。</p>
                </div>
                <div class="p1">
                    <p id="218">基于本文的方法, 我们实现了整机12.8万亿规模的<i>N</i>体问题测试 (16万核组, 每核组分配8千万个粒子) , FMM峰值性能达到41 PFLOPS, 相关的并行算法和模拟结果将另文阐述。</p>
                </div>
                <div class="area_img" id="219">
                    <p class="img_tit"><b>表2 FMM主要函数的计算时间 (粒子数:8千万</b>)  <a class="downexcel" onclick="DownLoadReportExcel(this)">导出到EXCEL</a></p>
                    <p class="img_tit"><b>Table 2 Runtime of main function for FMM (<i>N</i>=80 million</b>) </p>
                    <p class="img_note">s</p>
                    <table id="219" border="1"><tr><td><br />FMM的主要函数</td><td>运行时间</td><td>FMM的主要函数</td><td>运行时间</td></tr><tr><td><br />P2P</td><td>769.15</td><td>L2P</td><td>25.61</td></tr><tr><td><br />P2M</td><td>15.31</td><td>M2M和L2L</td><td>0.87</td></tr><tr><td><br />M2L</td><td>3.33</td><td></td><td></td></tr></table>
                    <form name="form" action="/kxreader/Detail/DownloadReportExcel" method="POST" style="display:inline">
                        <input type="hidden" name="hidTable" value="" />
                        <input type="hidden" name="hidFileName" value="" />
                    </form>
                    <p class="img_note"></p>
                    <p class="img_note"></p>
                </div>
                <h3 id="220" name="220" class="anchor-tag"><b>4 结束语</b></h3>
                <div class="p1">
                    <p id="221">本文在国产申威众核异构处理器申威SW26010上设计、实现了模拟<i>N</i>体问题的快速多极子方法, 并基于该处理器的架构进行包括DMA、向量化、循环展开、汇编指令重排等性能优化, 其中最耗时的粒子对相互作用核心函数kernel_p2p的运行速度提高了约400倍, 并达到处理器理论峰值性能的32.5%。</p>
                </div>

        <!--brief end-->
        
        <!--conten left  end-->
        <!--增强附件-->
                        <h3 class="anchor-tag">作者图片</h3>
                <div class="anchor-wrap">
                        <p>
                                    <div class="anchor-box">
                                        <span class="anchor-a"><image id="240" type="formula" href="images/JSJK201907003_24000.jpg" display="inline" placement="inline"><alt></alt></image></span>
                                        <span class="anchor-a">王武</span>
                                    </div>
                        </p>
                </div>


        <!--reference start-->
            <div class="reference anchor-tag" id="a_bibliography">
                    <h3>参考文献</h3>
                                        <p id="243">
                            <a id="bibliography_1" target="_blank" href="http://scholar.cnki.net/result.aspx?q=A hierarchical O(NlogN) force calculation algorithm">

                                <b>[1]</b> Barnes J, Hut P.A hierarchical O (N log N) force-calculation algorithm[J].Nature, 1986, 324 (6096) :446-449.
                            </a>
                        </p>
                        <p id="245">
                            <a id="bibliography_2" target="_blank" href="http://scholar.cnki.net/result.aspx?q=A fast algorithm for particle simulations">

                                <b>[2]</b> Greengard L, Rokhlin V.A fast algorithm for particle simulations[J].Journal of Computational Physics, 1987, 73 (2) :325-348.
                            </a>
                        </p>
                        <p id="247">
                            <a id="bibliography_3" target="_blank" href="http://scholar.cnki.net/result.aspx?q=FFT FMM or Multigrid?A comparative study of state-of-the-art Poisson solvers in the unit cube">

                                <b>[3]</b> Gholami A, Malhotra D, Sundar H, et al.FFT, FMM, or Multigrid?A comparative study of state-of-the-art Poisson solvers in the unit cube[J].SIAM Journal on Scientific Computing, 2014, 38 (3) :280-306.
                            </a>
                        </p>
                        <p id="249">
                            <a id="bibliography_4" target="_blank" href="/kcms/detail/detail.aspx?dbcode=SCUD&amp;filename=SCUD2B8C73D0A251E25FA3B3D251017024CE&amp;v=MzA0MTlKSUZwbWFCdUhZZk9HUWxmQ3BiUTM1TkJod3J1NnhhZz1OaTdlYXJIS0ZxTExyUHRGRmVrS0RRazd5bUJpNlUxK1BIM25yUkkwZnJLV1FjbnFDT052RlNpV1dyNw==&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[4]</b> Yahagi H, Yoshii Y.N-body code with adaptive mesh refinement[J].Proceedings of the International Astronomical Union, 2012, 558 (1) :463-475.
                            </a>
                        </p>
                        <p id="251">
                            <a id="bibliography_5" target="_blank" href="/kcms/detail/detail.aspx?dbcode=SSJD&amp;filename=SSJD00000079406&amp;v=MjA3MzlCYXJPNEh0SE1yNGhNWU9zSlkzazV6QmRoNGo5OVNYcVJyeG94Y01IN1I3cWVidWR0RkNEbFZiek5KVjQ9Tmo3&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[5]</b> Bagla J S.TreePM:A code for cosmological N-body simulations[J].Journal of Astrophysics &amp; Astronomy, 2002, 23 (3-4) :185-196.
                            </a>
                        </p>
                        <p id="253">
                            <a id="bibliography_6" target="_blank" href="http://scholar.cnki.net/result.aspx?q=Particle-particle-particle-mesh (P3M) algorithms">

                                <b>[6]</b> Hockney R W, Eastwood J W.Particle-particle-particle-mesh (P3M) algorithms[M]//Computer Simulation Using Particles.Boca Roton, FL, USA:CRC Press, 1988:267-304.
                            </a>
                        </p>
                        <p id="255">
                            <a id="bibliography_7" target="_blank" href="http://scholar.cnki.net/result.aspx?q=Guest Editors Introduction to the top 10 algorithms">

                                <b>[7]</b> Dongarra J, Sullivan F.Introduction to the top 10 algorithms[J].Computing in Science and Engineering, 2000, 2 (1) :22-23.
                            </a>
                        </p>
                        <p id="257">
                            <a id="bibliography_8" target="_blank" href="http://scholar.cnki.net/result.aspx?q=4.45Pflops Astrophysical NBody Simulation on K Computer-The Gravitational TrillionBody Problem">

                                <b>[8]</b> Ishiyama T, Nitadori K, Makino J.4.45 PFLOPS astrophysical N-body simulation on K computer-The gravitational trillion-body problem[C]//Proc of the International Conference on High Performance Computing, Networking, Storage and Analysis, 2012:1-10.
                            </a>
                        </p>
                        <p id="259">
                            <a id="bibliography_9" target="_blank" href="/kcms/detail/detail.aspx?dbcode=SSJD&amp;filename=SSJD345DC005251D71B795B59EE3E0198BEA&amp;v=MjQxNTlXV3I3SklGcG1hQnVIWWZPR1FsZkNwYlEzNU5CaHdydTZ4YWc9Tmo3QmFyQzhHNlcvcjQ5QVp1NE9lSHM0dlJFYTcwMTRRUXFYcjJjMWVMdWNOOC91Q09OdkZTaQ==&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[9]</b> Potter D, Stadel J, Teyssier, R.PKDGRAV3:Beyond trillion particle cosmological simulations for the next era of galaxy surveys[J].Computational Astrophysics &amp; Cosmology, 2016, 4 (1) :2-13.
                            </a>
                        </p>
                        <p id="261">
                            <a id="bibliography_10" >
                                    <b>[10]</b>
                                 Wang Wu, Feng Yang-de, Chi Xue-bin.Application of tree structure in N-body problem[J].Application Research of Computers, 2008, 25 (1) :42-44. (in Chinese) 
                            </a>
                        </p>
                        <p id="263">
                            <a id="bibliography_11" >
                                    <b>[11]</b>
                                 Li Chan-yi, Wang Wu, Feng Yang-de.High efficient parallel implementation of BH algorithm on heterogeneous platforms[J].Application Research of Computers, 2016, 33 (8) :2255-2259. (in Chinese) 
                            </a>
                        </p>
                        <p id="265">
                            <a id="bibliography_12" >
                                    <b>[12]</b>
                                 Xu Lei, Xu Ying.Investigation of the implementation of N-body problem on GPUs[J].Computer Applications and Software, 2012, 29 (1) :92-95. (in Chinese) 
                            </a>
                        </p>
                        <p id="267">
                            <a id="bibliography_13" >
                                    <b>[13]</b>
                                 Li Qi-gang, Chai Ya-hui, Xu Wei-min, et al.Research and realization of N-body probelm on FPGA accelorator based on FMM algorithms[J].Computer Engeneering and Design, 2011, 32 (10) :3391-3394. (in Chinese) 
                            </a>
                        </p>
                        <p id="269">
                            <a id="bibliography_14" target="_blank" href="http://scholar.cnki.net/result.aspx?q=Fast algorithms for spherical harmonic expansions">

                                <b>[14]</b> Rokhlin V, Tygert M.Fast algorithms for spherical harmonic expansions[J].SIAM Journal on Scientific Computing, 2006, 27 (6) :1903-1928.
                            </a>
                        </p>
                        <p id="271">
                            <a id="bibliography_15" target="_blank" href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JFXG201607011&amp;v=MTY3NjFIODR2UjRUNmo1NE8zenFxQnRHRnJDVVJMT2VaZVJtRnk3bVZycklMeXZUYWJHNEg5Zk1xSTlFWllRS0Q=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[15]</b> Fu Hao-huan, Liao Jun-feng, Yang Jin-zhe, et al.The Sunway TaihuLight supercomputer:System and applications[J].Science China Information Sciences, 2016, 59 (7) :1-16.
                            </a>
                        </p>
                        <p id="273">
                            <a id="bibliography_16" target="_blank" href="/kcms/detail/detail.aspx?dbcode=SJCM&amp;filename=SJCM13091000017385&amp;v=MDY2MDM3SHRqTnI0OUZaT29JRDNROG9CTVQ2VDRQUUgvaXJSZEdlcnFRVE1ud1plWnVIeWptVUxmSUpsMFJieEk9TmlmSVk3Sw==&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[16]</b> Soderquist P, Leeser M.Area and performance tradeoffs in floating-point divide and square-root implementations[J].ACM Computing Surveys, 1996, 28 (3) :518-564.
                            </a>
                        </p>
                        <p id="275">
                            <a id="bibliography_17" target="_blank" href="http://scholar.cnki.net/result.aspx?q=Design and optimization of parallel programs on Sunway TaihuLight">

                                <b>[17]</b> Chen De-xun, Liu Xin.Design and optimization of parallel programs on Sunway TaihuLight[Z].Wuxi:Tech Manual of The National Supercomputing Center in Wuxi, 2017. (in Chinese) 
                            </a>
                        </p>
                        <p id="277">
                            <a id="bibliography_10" target="_blank" href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JSYJ200801011&amp;v=MjUxODFyQ1VSTE9lWmVSbUZ5N21WcnJJTHo3U1pMRzRIdG5Ncm85RVpZUUtESDg0dlI0VDZqNTRPM3pxcUJ0R0Y=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[10]</b> 王武, 冯仰德, 迟学斌.树结构在N体问题中的应用[J].计算机应用研究, 2008, 25 (1) :42-44.
                            </a>
                        </p>
                        <p id="279">
                            <a id="bibliography_11" target="_blank" href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JSYJ201608004&amp;v=MjA2NzR6cXFCdEdGckNVUkxPZVplUm1GeTdtVnJySUx6N1NaTEc0SDlmTXA0OUZZSVFLREg4NHZSNFQ2ajU0TzM=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[11]</b> 李婵怡, 王武, 冯仰德.基于异构平台的BH算法高效并行实现[J].计算机应用研究, 2016, 33 (8) :2255-2259.
                            </a>
                        </p>
                        <p id="281">
                            <a id="bibliography_12" target="_blank" href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JYRJ201201027&amp;v=MTQxMzMzenFxQnRHRnJDVVJMT2VaZVJtRnk3bVZycklMelRaWkxHNEg5UE1ybzlIWTRRS0RIODR2UjRUNmo1NE8=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[12]</b> 徐磊, 徐莹.多体问题在GPU上实现的讨论[J].计算机应用与软件, 2012, 29 (1) :92-95.
                            </a>
                        </p>
                        <p id="283">
                            <a id="bibliography_13" target="_blank" href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=SJSJ201110035&amp;v=MDQzOTBETnI0OUdZWVFLREg4NHZSNFQ2ajU0TzN6cXFCdEdGckNVUkxPZVplUm1GeTdtVnJySU5pZllaTEc0SDk=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">

                                <b>[13]</b> 李琪刚, 柴亚辉, 徐炜民, 等.多体问题FMM算法在加速部件FPGA研究与实现[J], 计算机工程与设计, 2011, 32 (10) :3391-3394.
                            </a>
                        </p>
                        <p id="285">
                            <a id="bibliography_17" >
                                    <b>[17]</b>
                                 陈德训, 刘鑫.神威·太湖之光并行程序设计与优化[Z].无锡:国家超级计算无锡中心技术手册, 2017.
                            </a>
                        </p>
            </div>
        <!--reference end-->
        <!--footnote start-->
        <!--footnote end-->



    </div>

        <input id="fileid" type="hidden" value="JSJK201907003" />
        <input id="dpi" type="hidden" value="300" />
    </div>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6e967eb120601ea41b9d312166416aa6";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

    


<input id="hid_uid" name="hid_uid" type="hidden" value="WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!" />
<input id="hid_kLogin_headerUrl" name="hid_kLogin_headerUrl" type="hidden" value="/KLogin/Request/GetKHeader.ashx%3Fcallback%3D%3F" />
<input id="hid_kLogin_footerUrl" name="hid_kLogin_footerUrl" type="hidden" value="/KLogin/Request/GetKFooter.ashx%3Fcallback%3D%3F" />
<div class="btn-link" style="display: none"><a target="_blank" href="/kcms/detail/detail.aspx?dbcode=CJFD&amp;filename=JSJK201907003&amp;v=MTAyMjg2ajU0TzN6cXFCdEdGckNVUkxPZVplUm1GeTdtVnJySUx6N0JaYkc0SDlqTXFJOUZaNFFLREg4NHZSNFQ=&amp;uid=WEEvREcwSlJHSldRa1FhdkJkVG5hVDY2UXI4RUJreUIrY05aSWZBQVJmWT0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!">知网节</a></div>
<div class="popflow" id="popupTips" style="display: none;">
    <div class="popflowArr"></div>
    <div class="popflowCot">
        <div class="hd"><a href="javascript:void(0);" onclick="$('#popupTips').hide();$('#popupmsg').html('')" class="close">X</a></div>
        <div class="bd">
            <p class="mes" id="popupmsg" name="popupmsg"></p>
          
        </div>
    </div>
</div>
<input type="hidden" id="myexport" value="//kns.cnki.net" />

<input type="hidden" id="KPCAPIPATH" value="//ishufang.cnki.net" />
<input type="hidden" id="CitedTimes" value="" />
<div class="link" id="GLSearch" style="display: none;">
    <i class="icon-trangle"></i>
    <div class="inner">
        <a class="icon" id="copytext">复制</a>
        <a class="icon" target="_blank" onclick="searchCRFD(this)">工具书搜索</a>
    </div>
</div>




<input id="hidVirtualPath" name="hidVirtualPath" type="hidden" value="/kxreader" />
<script src="/kxreader/bundles/detail?v=-ULdk-c6FkZHtJA2KAXPgHnyA8mtgyPnBde_C2VZ2BY1"></script>

<script src="/kxreader/Scripts/layer.min.js" type="text/javascript"></script>

<div id="footerBox" class="rootw footer">
</div>
<script>
    if (typeof FlushLogin == 'function') {
        FlushLogin();
    }
    modifyEcpHeader(true);
</script>

<!--图片放大功能 start-->
<script src="/kxreader/bundles/imagebox?v=W4phPu9SNkGcuPeJclikuVE3PpRyIW_gnfjm_19nynI1"></script>

<script type="text/javascript">
    $(function () {
        var j = $.noConflict();
        j(function () {
            j(".zoom-in,.btn-zoomin").imgbox({
                'alignment': 'center',
                'allowMultiple': false,
                'overlayShow': true
            });
        })
    });
</script>
<!--图片放大功能 end-->
<div class="fixedbar">
    <div class="backtop hiddenV" id="backtop">
        <a id="backTopSide" href="javascript:scroll(0,0);" title=""></a>
    </div>
</div>
<script type="text/javascript" src="/kxreader/Scripts/MathJax-2.6-latest/MathJax.js?config=MML_HTMLorMML-full"></script>

</body>
</html>
